<project
    xmlns:j="jelly:core"
    xmlns:maven="jelly:maven"
    xmlns:ant="jelly:ant"
    default="main">

    <preGoal name="java:compile">
        <ant:mkdir dir="${basedir}/target/src/java/org/jcontainer/loom/interfaces"/>
        <ant:tstamp/>
        <j:file name="${basedir}/target/src/java/org/jcontainer/loom/interfaces/Version.java"
            omitXmlDeclaration="true" escapeText="false">
            package org.jcontainer.loom.interfaces;
            interface Version
            {
            String SOFTWARE = "${pom.name}";
            String VERSION = "${pom.currentVersion}";
            String DATE = "${TODAY}";
            }
        </j:file>
        <ant:path id="version.src.set"
            location="${basedir}/target/src/java"/>
        <maven:addPath id="maven.compile.src.set" refid="version.src.set"/>
    </preGoal>

    <goal name="main">
        <attainGoal name="build"/>
    </goal>

    <postGoal name="java:compile">
        <ant:taskdef name="metagenerate"
            classname="org.jcontainer.loom.info.GenerateLoomDescriptorsTask">
            <ant:classpath>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
        </ant:taskdef>
        <ant:echo message="Generating Component Descriptors"/>
        <ant:mkdir dir="${maven.build.dest}"/>
        <metagenerate destDir="${maven.build.dest}">
            <ant:fileset dir="${maven.sar.metagenerate.src}"/>
        </metagenerate>
    </postGoal>

    <goal name="build">
        <attainGoal name="jar:install"/>
    </goal>

    <goal name="deploy">
        <attainGoal name="jar:deploy"/>
    </goal>

    <postGoal name="test:compile">
        <ant:taskdef name="metagenerate"
            classname="org.jcontainer.loom.info.GenerateLoomDescriptorsTask">
            <ant:classpath>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
        </ant:taskdef>
        <ant:echo message="Generating Component Descriptors For Unit Tests"/>
        <ant:mkdir dir="${basedir}/target/test-classes"/>
        <metagenerate destDir="${basedir}/target/test-classes">
            <ant:fileset dir="src/test">
                <include name="**/data/*"/>
            </ant:fileset>
        </metagenerate>
    </postGoal>

</project>
